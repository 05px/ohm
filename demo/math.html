<!doctype html>
<html>
  <head>
    <title>ohm/js math demo</title>
    <link href="math.css" rel="stylesheet"></link>
    <script src="lib.js"></script>
    <script type="text/ohm-js" id="arithmetic">

Arithmetic {
  Expr
    = AddExpr

  AddExpr
    = AddExpr:x '+':op MulExpr:y  -- plus
    | AddExpr:x '-':op MulExpr:y  -- minus
    | MulExpr

  MulExpr
    = MulExpr:x '*':op ExpExpr:y  -- times
    | MulExpr:x '/':op ExpExpr:y  -- divide
    | ExpExpr

  ExpExpr
    = PriExpr:x '^':op ExpExpr:y  -- power
    | PriExpr

  PriExpr
    = '(':open Expr:e ')':close   -- paren
    | '+':sign PriExpr:e          -- pos
    | '-':sign PriExpr:e          -- neg
    | ident
    | number

  ident  -- identifier
    = letter alnum*

  number  -- number
    = digit+ ('.' digit*)?
    | '.' digit+
}

    </script>
  </head>
  <body>
    <input type="text" id="input" placeholder="Enter an arithmetic expression..." autofocus="true"></input>
    <div id="errorDiv">
      <div id="spaces"></div>
      <wrapperWrapper><wrapper>
        <div id="error"><label>Expected: </label><span id="errorDetails"></span></div>
      </wrapper></wrapperWrapper>
    </div>
    <div id="value"></div>
    <div id="lisp"></div>
    <div id="tree"></div>
    <div id="twoD"></div>
    <script src="../dist/ohm.js"></script>
    <script>

var g = ohm.namespace('test')
           .loadGrammarsFromScriptElement(document.getElementById('arithmetic'))
           .getGrammar('Arithmetic');

// ---------------------------------------------------------------------------------------------------------------------

var constants = {pi: Math.PI, e: Math.E};
var interpret = {
  Expr:           function(expr)           { return expr.value; },
  AddExpr:        function(expr)           { return expr.value; },
  AddExpr_plus:   function(x, op, y)       { return x.value + y.value; },
  AddExpr_minus:  function(x, op, y)       { return x.value - y.value; },
  MulExpr:        function(expr)           { return expr.value; },
  MulExpr_times:  function(x, op, y)       { return x.value * y.value; },
  MulExpr_divide: function(x, op, y)       { return x.value / y.value; },
  ExpExpr:        function(expr)           { return expr.value; },
  ExpExpr_power:  function(x, op, y)       { return Math.pow(x.value, y.value); },
  PriExpr:        function(expr)           { return expr.value; },
  PriExpr_paren:  function(open, e, close) { return e.value; },
  PriExpr_pos:    function(sign, e)        { return e.value; },
  PriExpr_neg:    function(sign, e)        { return -e.value; },
  ident:          function()               { return constants[this.interval.contents]; },
  number:         function()               { return parseFloat(this.interval.contents); }
};

// ---------------------------------------------------------------------------------------------------------------------

function toLisp(x) {
  if (x instanceof Array) {
    var parts = [];
    for (var idx = 0; idx < x.length; idx++) {
      parts.push(toLisp(x[idx]));
    }
    return ['(', parts.join(' '), ')'].join('');
  } else {
    return x.toString();
  }
}

var parse = {
  Expr:           function(expr)           { return toLisp(expr.value); },
  AddExpr:        function(expr)           { return expr.value; },
  AddExpr_plus:   function(x, op, y)       { return ['+', x.value, y.value]; },
  AddExpr_minus:  function(x, op, y)       { return ['-', x.value, y.value]; },
  MulExpr:        function(expr)           { return expr.value; },
  MulExpr_times:  function(x, op, y)       { return ['*', x.value, y.value]; },
  MulExpr_divide: function(x, op, y)       { return ['/', x.value, y.value]; },
  ExpExpr:        function(expr)           { return expr.value; },
  ExpExpr_power:  function(x, op, y)       { return ['pow', x.value, y.value]; },
  PriExpr:        function(expr)           { return expr.value; },
  PriExpr_paren:  function(open, e, close) { return e.value; },
  PriExpr_pos:    function(sign, e)        { return e.value; },
  PriExpr_neg:    function(sign, e)        { return ['neg', e.value]; },
  ident:          function()               { return this.interval.contents; },
  number:         function()               { return this.interval.contents; }
};

// ---------------------------------------------------------------------------------------------------------------------

var toTree = {
  Expr:           function(expr)           { return makeElement('expr', expr.value); },
  AddExpr:        function(expr)           { return makeElement('addExpr', expr.value); },
  AddExpr_plus:   function(x, op, y)       { return makeElement('plus', x.value, op.value, y.value); },
  AddExpr_minus:  function(x, op, y)       { return makeElement('minus', x.value, op.value, y.value); },
  MulExpr:        function(expr)           { return makeElement('mulExpr', expr.value); },
  MulExpr_times:  function(x, op, y)       { return makeElement('times', x.value, op.value, y.value); },
  MulExpr_divide: function(x, op, y)       { return makeElement('divide', x.value, op.value, y.value); },
  ExpExpr:        function(expr)           { return makeElement('expExpr', expr.value); },
  ExpExpr_power:  function(x, op, y)       { return makeElement('power', x.value, op.value, y.value); },
  PriExpr:        function(expr)           { return makeElement('priExpr', expr.value); },
  PriExpr_paren:  function(open, e, close) { return makeElement('paren', open.value, e.value, env.close); },
  PriExpr_pos:    function(sign, e)        { return makeElement('pos', sign.value, e.value); },
  PriExpr_neg:    function(sign, e)        { return makeElement('neg', sign.value, e.value); },
  ident:          function()               { return makeElement('ident', this.interval.contents); },
  number:         function()               { return makeElement('number', this.interval.contents); }
};

// ---------------------------------------------------------------------------------------------------------------------

var toTwoD = {
  Expr:           function(expr)           { return expr.value; },
  AddExpr:        function(expr)           { return expr.value; },
  AddExpr_plus:   function(x, op, y)       { var operator = makeElement('operator', op.value);
                                             return makeElement('plus', x.value, operator, y.value); },
  AddExpr_minus:  function(x, op, y)       { var operator = makeElement('operator', '\u2212');
                                             return makeElement('minus', x.value, operator, y.value); },
  MulExpr:        function(expr)           { return expr.value; },
  MulExpr_times:  function(x, op, y)       { var operator = makeElement('operator', '\u00D7');
                                             return makeElement('times', x.value, operator, y.value); },
  MulExpr_divide: function(x, op, y)       { var numerator = makeElement('numerator', x.value);
                                             var denominator = makeElement('denominator', y.value);
                                             return makeElement('fraction', numerator, denominator); },
  ExpExpr:        function(expr)           { return expr.value; },
  ExpExpr_power:  function(x, op, y)       { var base = makeElement('base', x.value);
                                             var exponent = makeElement('exponent', y.value);
                                             return makeElement('power', base, exponent); },
  PriExpr:        function(expr)           { return expr.value; },
  PriExpr_paren:  function(open, e, close) { return makeElement('paren', e.value); },
  PriExpr_pos:    function(sign, e)        { return makeElement('pos', sign.value, e.value); },
  PriExpr_neg:    function(sign, e)        { return makeElement('neg', sign.value, e.value); },
  ident:          function()               { var text = this.interval.contents;
                                             return makeElement('ident', text === 'pi' ? '\u03C0' : text); },
  number:         function()               { return makeElement('number', this.interval.contents); }
};

// ---------------------------------------------------------------------------------------------------------------------

var input = document.getElementById('input');
var spaces = document.getElementById('spaces');
var error = document.getElementById('error');
var errorDetails = document.getElementById('errorDetails');

input.value = '';
hideError();

input.oninput = function() {
  hideError();
  try {
    var thunk = g.matchContents(this.value, 'Expr', true);
    this.className = undefined;
    show('value', thunk(interpret));
    show('lisp', thunk(parse));
    show('tree', thunk(toTree));
    show('twoD', thunk(toTwoD));
  } catch (e) {
    if (this.value.length === 0) {
      show('value', '');
      show('lisp', '');
      show('tree', '');
      show('twoD', '');
    } else {
      this.className = 'error';
      showError(e);
    }
  }
};

function hideError() {
  errorDiv.className = errorDiv.className = 'hidden';
}

function showError(e) {
  setTimeout(function() {
    // Position the error bubble to line up with the offending input
    spaces.innerHTML = repeat(' ', e.getPos());

    // Set up the details, i.e., what input was expected at that position
    removeChildren(errorDetails);
    e.getExpected().forEach(function(text, idx, expected) {
      var element = createExpectedElement(text);
      if (idx > 0) {
        errorDetails.appendChild(makeElement('light', idx === expected.length - 1 ? ', or ' : ', '));
      }
      errorDetails.appendChild(element);
    });

    // Show error
    errorDiv.className = 'visible';
  }, 0);
}

function createExpectedElement(s) {
  if (s.charAt(0) === '"' && s.charAt(s.length - 1) === '"' ||
      s.charAt(0) === "'" && s.charAt(s.length - 1) === "'") {
    return makeElement('literal',
      makeElement('light', '"'),
      makeElement('code', s.substr(1, s.length - 2)),
      makeElement('light', '"'));
  } else {
    return makeElement('description', s);
  }
}

    </script>
  </body>
</html>

