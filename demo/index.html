<!doctype html>
<html>
  <head>
    <title>ohm/js demo</title>
    <link href="demo.css" rel="stylesheet"></style>
    <script src="lib.js"></script>
    <script type="text/ohm-js" id="arithmetic">

Arithmetic {
  Expr    == AddExpr
  AddExpr == AddExpr.x '+'.op MulExpr.y  {plus}
           | AddExpr.x '-'.op MulExpr.y  {minus}
           | MulExpr
  MulExpr == MulExpr.x '*'.op ExpExpr.y  {times}
           | MulExpr.x '/'.op ExpExpr.y  {divide}
           | ExpExpr
  ExpExpr == PriExpr.x '^'.op ExpExpr.y  {power}
           | PriExpr
  PriExpr == '('.open Expr.e ')'.close   {paren}
           | '+'.sign PriExpr.e          {pos}
           | '-'.sign PriExpr.e          {neg}
           | ident
           | number
  ident   == letter alnum*
  number  == digit+ ('.' digit*)?
           | '.' digit+
}

    </script>
  </head>
  <body>
    <input type="text" id="input"></input>
    <div id="value"></div>
    <div id="lisp"></div>
    <div id="tree"></div>
    <div id="twoD"></div>
    <script src="../dist/ohm.js"></script>
    <script>

var g = ohm.namespace('test')
           .loadGrammarsFromScriptElement(document.getElementById('arithmetic'))
           .getGrammar('Arithmetic')

// ---------------------------------------------------------------------------------------------------------------------

var env = {pi: Math.PI, e: Math.E}
var interpret = {
  Expr:             function(env) { return env.value },
  AddExpr:          function(env) { return env.value },
  'AddExpr-plus':   function(env) { return env.x + env.y },
  'AddExpr-minus':  function(env) { return env.x - env.y },
  MulExpr:          function(env) { return env.value },
  'MulExpr-times':  function(env) { return env.x * env.y },
  'MulExpr-divide': function(env) { return env.x / env.y },
  ExpExpr:          function(env) { return env.value },
  'ExpExpr-power':  function(env) { return Math.pow(env.x, env.y) },
  PriExpr:          function(env) { return env.value },
  'PriExpr-paren':  function(env) { return env.e },
  'PriExpr-pos':    function(env) { return env.e },
  'PriExpr-neg':    function(env) { return -env.e },
  ident:            function()    { return env[this.interval.contents] },
  number:           function()    { return parseFloat(this.interval.contents) }
}

// ---------------------------------------------------------------------------------------------------------------------

function toLisp(x) {
  if (x instanceof Array) {
    var parts = []
    for (var idx = 0; idx < x.length; idx++)
      parts.push(toLisp(x[idx]))
    return ['(', parts.join(' '), ')'].join('')
  } else
    return x.toString()
}

var parse = {
  Expr:             function(env) { return toLisp(env.value) },
  AddExpr:          function(env) { return env.value },
  'AddExpr-plus':   function(env) { return ['+', env.x, env.y] },
  'AddExpr-minus':  function(env) { return ['-', env.x, env.y] },
  MulExpr:          function(env) { return env.value },
  'MulExpr-times':  function(env) { return ['*', env.x, env.y] },
  'MulExpr-divide': function(env) { return ['/', env.x, env.y] },
  ExpExpr:          function(env) { return env.value },
  'ExpExpr-power':  function(env) { return ['pow', env.x, env.y] },
  PriExpr:          function(env) { return env.value },
  'PriExpr-paren':  function(env) { return env.e },
  'PriExpr-pos':    function(env) { return env.e },
  'PriExpr-neg':    function(env) { return ['neg', env.e] },
  ident:            function()    { return this.interval.contents },
  number:           function()    { return this.interval.contents }
}

// ---------------------------------------------------------------------------------------------------------------------

var toTree = {
  Expr:             function(env) { return makeElement('expr', env.value) },
  AddExpr:          function(env) { return makeElement('addExpr', env.value) },
  'AddExpr-plus':   function(env) { return makeElement('plus', env.x, env.op, env.y) },
  'AddExpr-minus':  function(env) { return makeElement('minus', env.x, env.op, env.y) },
  MulExpr:          function(env) { return makeElement('mulExpr', env.value) },
  'MulExpr-times':  function(env) { return makeElement('times', env.x, env.op, env.y) },
  'MulExpr-divide': function(env) { return makeElement('divide', env.x, env.op, env.y) },
  ExpExpr:          function(env) { return makeElement('expExpr', env.value) },
  'ExpExpr-power':  function(env) { return makeElement('power', env.x, env.op, env.y) },
  PriExpr:          function(env) { return makeElement('priExpr', env.value) },
  'PriExpr-paren':  function(env) { return makeElement('paren', env.open, env.e, env.close) },
  'PriExpr-pos':    function(env) { return makeElement('pos', env.sign, env.e) },
  'PriExpr-neg':    function(env) { return makeElement('neg', env.sign, env.e) },
  ident:            function()    { return makeElement('ident', this.interval.contents) },
  number:           function()    { return makeElement('number', this.interval.contents) }
}

// ---------------------------------------------------------------------------------------------------------------------

var toTwoD = {
  Expr:             function(env) { return env.value },
  AddExpr:          function(env) { return env.value },
  'AddExpr-plus':   function(env) { var operator = makeElement('operator', env.op)
                                    return makeElement('plus', env.x, operator, env.y) },
  'AddExpr-minus':  function(env) { var operator = makeElement('operator', '\u2212')
                                    return makeElement('minus', env.x, operator, env.y) },
  MulExpr:          function(env) { return env.value },
  'MulExpr-times':  function(env) { var operator = makeElement('operator', '\u00D7')
                                    return makeElement('times', env.x, operator, env.y) },
  'MulExpr-divide': function(env) { var numerator = makeElement('numerator', env.x)
                                    var denominator = makeElement('denominator', env.y)
                                    return makeElement('fraction', numerator, denominator) },
  ExpExpr:          function(env) { return env.value },
  'ExpExpr-power':  function(env) { var base = makeElement('base', env.x)
                                    var exponent = makeElement('exponent', env.y)
                                    return makeElement('power', base, exponent) },
  PriExpr:          function(env) { return env.value },
  'PriExpr-paren':  function(env) { return makeElement('paren', env.e) },
  'PriExpr-pos':    function(env) { return makeElement('pos', env.sign, env.e) },
  'PriExpr-neg':    function(env) { return makeElement('neg', env.sign, env.e) },
  ident:            function()    { var text = this.interval.contents
                                    return makeElement('ident', text === 'pi' ? '\u03C0' : text) },
  number:           function()    { return makeElement('number', this.interval.contents) }
}

// ---------------------------------------------------------------------------------------------------------------------

var input = document.getElementById('input')

input.value = ''

input.oninput = function() {
  var thunk = g.matchContents(this.value, 'Expr')
  if (thunk) {
    this.className = undefined
    show('value', thunk(interpret))
    show('lisp', thunk(parse))
    show('tree', thunk(toTree))
    show('twoD', thunk(toTwoD))
  } else {
    this.className = 'error'
    if (this.value.length === 0) {
      show('value', '')
      show('lisp', '')
      show('tree', '')
      show('twoD', '')
    }
  }
}

    </script>
  </body>
</html>

