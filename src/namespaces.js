// --------------------------------------------------------------------
// Imports
// --------------------------------------------------------------------

var ohm = require("./main.js");
var errors = require("./errors.js");

// --------------------------------------------------------------------
// Private Stuff
// --------------------------------------------------------------------

// TODO: just use the jQuery thing
function load(url) {
  var req = new XMLHttpRequest();
  req.open("GET", url, false);
  try {
    req.send();
    if (req.status === 0 || req.status === 200) {
      return req.responseText;
    }
  } catch (e) {}
  throw new Error("unable to load url " + url);
}

var namespaces = {};

// --------------------------------------------------------------------
// Namespaces
// --------------------------------------------------------------------

function namespace(name) {
  return namespaces[name] ?
    namespaces[name] :
    (namespaces[name] = new Namespace(name));
}

function Namespace(name) {
  this.name = name;
  this.grammars = {};
}

Namespace.prototype = {
  install: function(grammar) {
    if (grammar.namespaceName) {
      throw new Error(
        "cannot install grammar " + grammar.name + " into namespace " + this.name +
        " because it's already in namespace " + grammar.namespaceName);
    } else if (this.grammars[grammar.name]) {
      throw new errors.DuplicateGrammarDeclaration(grammar.name, this.name);
    } else {
      this.grammars[grammar.name] = grammar;
      grammar.namespaceName = this.name;
      return this;
    }
  },

  grammar: function(name) {
    if (this.grammars[name]) {
      return this.grammars[name];
    } else {
      throw new errors.UndeclaredGrammar(name, this.name);
    }
  },

  loadGrammarsFromScriptElement: function(element) {
    if (element.type !== "text/ohm-js") {
      throw new Error("script tag's type attribute must be text/ohm-js");
    }
    var source = element.getAttribute("src") ? load(element.getAttribute("src")) : element.innerHTML;
    try {
      ohm.makeGrammars(source, this.name);
    } catch (e) {}
    return this;
  },

  make: function(recipe) {
    return recipe(ohm, this);
  }
};

// --------------------------------------------------------------------
// Exports
// --------------------------------------------------------------------

module.exports = namespace;

